<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>Лабораторная работа №2 - Kosmach Mariia K3339 2 lab</title>
        <link href="../css/bootstrap.min.css" rel="stylesheet">
        <link href="../css/fontawesome.min.css" rel="stylesheet">
        <link href="../css/brands.min.css" rel="stylesheet">
        <link href="../css/solid.min.css" rel="stylesheet">
        <link href="../css/v4-font-face.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link id="hljs-light" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" >
        <link id="hljs-dark" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" disabled>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="..">Kosmach Mariia K3339 2 lab</a>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">

                    <ul class="nav navbar-nav ms-md-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-bs-toggle="collapse" data-bs-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-body-tertiary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-bs-level="1"><a href="#no2" class="nav-link">Лабораторная работа №2</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-bs-level="2"><a href="#_1" class="nav-link">Ход выполнения работы</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#_2" class="nav-link">Результат</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="no2">Лабораторная работа №2</h1>
<p>Табло должно отображать информацию об участниках автогонок: ФИО участника,
название команды, описание автомобиля, описание участника, опыт и класс участника.
Необходимо реализовать следующий функционал:
- Регистрация новых пользователей.
- Просмотр автогонок и регистрацию гонщиков. Пользователь должен иметь
возможность редактирования и удаления своих регистраций.
- Написание отзывов и комментариев к автогонкам. Предварительно
комментатор должен зарегистрироваться. При добавлении комментариев
должны сохраняться даты заезда, текст комментария, тип комментария
(вопрос о сотрудничестве, вопрос о гонках, иное), рейтинг (1-10),
информация о комментаторе.
- Администратор должен иметь возможность указания времени заезда и
результата средствами Django-admin.
- В клиентской части должна формироваться таблица всех заездов и
результатов конкретной гонки.</p>
<h2 id="_1">Ход выполнения работы</h2>
<h3 id="modelspy">models.py:</h3>
<pre><code>class User(AbstractUser):
first_name = models.CharField(max_length=30)
last_name = models.CharField(max_length=30)
has_racer = models.BooleanField(default=False)

def __str__(self):
    return f"{self.first_name} {self.last_name}"


class Racer(models.Model):
    user = models.OneToOneField(User, on_delete=models.CASCADE)
    team = models.CharField(max_length=100)
    car = models.CharField(max_length=100)
    description = models.TextField()
    experience = models.IntegerField()
    type = models.CharField(max_length=100)


class Race(models.Model):
    name = models.CharField(max_length=100)
    date = models.DateTimeField()
    winner = models.ForeignKey(Racer, on_delete=models.SET_NULL, blank=True, null=True)

    def __str__(self):
        return f"{self.name}"


class RaceConnection(models.Model):
    racer = models.ForeignKey(Racer, on_delete=models.CASCADE)
    race = models.ForeignKey(Race, on_delete=models.CASCADE)

    class Meta:
        unique_together = ('racer', 'race')


class Comment(models.Model):
    COMMENT_TYPES = (
        ("cooperation", "Сотрудничество"),
        ("race", "Гонка"),
        ("other", "Другое")
    )
    race = models.ForeignKey(Race, on_delete=models.CASCADE)
    author = models.ForeignKey(User, on_delete=models.CASCADE)
    text = models.TextField()
    comment_type = models.CharField(max_length=20, choices=COMMENT_TYPES)
    rating = models.IntegerField(
        validators=[MinValueValidator(0), MaxValueValidator(10)]
    )
    created_at = models.DateTimeField(auto_now_add=True)
</code></pre>
<h3 id="viewspy">views.py:</h3>
<pre><code>def user_logout(request):
logout(request)
return render(request, 'logout.html')


def user_login(request):
    if request.method == 'POST':
        form = LoginForm(request.POST)
        if form.is_valid():
            cd = form.cleaned_data
            user = authenticate(username=cd['username'], password=cd['password'])
            if user is not None:
                if user.is_active:
                    login(request, user)
                    return redirect('profile')
                else:
                    return HttpResponse('Disabled account')
            else:
                return HttpResponse('Invalid login or password')
    else:
        form = LoginForm()
    return render(request, 'login.html', {'form': form})


def registration(request):
    if request.method == "POST":
        form = RegistrationForm(request.POST)
        if form.is_valid():
            user = form.save()
            user.set_password(user.password)
            user.save()
            return redirect("login")
    else:
        form = RegistrationForm()

    return render(request, "registration.html", {"user_form": form})


def index(request):
    return render(request, "index.html")


@login_required
def profile(request):
    return render(request, 'profile.html', {'section': 'profile', 'has_racer': hasattr(request.user, 'racer')})


@login_required
def racer_registration(request):
    user = request.user
    print(user.has_racer)
    if hasattr(request.user, "racer"):
        return HttpResponse("You have already got a racer")
    else:
        if request.method == "POST":

            racer_form = RacerForm(request.POST)
            if racer_form.is_valid():
                print(user)
                racer = racer_form.save(commit=False)
                racer.user = user
                racer.save()
                user.has_racer = True
                user.save()
                return redirect("profile")
        else:
            racer_form = RacerForm()

    return render(request, "racer_registration.html", {"racer_form": racer_form})


@login_required
def edit_user(request):
    if request.method == "POST":
        user_form = UserUpdateForm(request.POST, instance=request.user)
        if user_form.is_valid():
            user_form.save()
            return redirect('profile')
    else:
        user_form = UserUpdateForm(instance=request.user)
    return render(request, "edit_user.html", {"user_form": user_form}, )


@login_required
def change_password(request):
    if request.method == "POST":
        password_form = PasswordChangeForm(request.user, request.POST)

        if password_form.is_valid():
            user = password_form.save()
            update_session_auth_hash(request, user)
            return redirect("profile")
    else:
        password_form = PasswordChangeForm(request.user)
    return render(request, "change_password.html", {"password_form": password_form, })


@login_required()
def edit_racer(request):
    if request.method == "POST":
        racer_form = RacerForm(request.POST, instance=request.user.racer)
        if racer_form.is_valid():
            racer_form.save()
            return redirect("profile")
    else:
        if hasattr(request.user, "racer"):
            racer_form = RacerForm(instance=getattr(request.user, "racer", None))
        else:
            racer_form = None
    return render(request, "edit_racer.html", {"racer_form": racer_form, })


@login_required
def race_comments(request, race_id):
    race = get_object_or_404(Race, id=race_id)
    comments = Comment.objects.filter(race=race)
    if request.method == "POST":
        form = CommentForm(request.POST)
        if form.is_valid():
            comment = form.save(commit=False)
            comment.race = race
            comment.author = request.user
            comment.save()
    else:
        form = CommentForm()
    return render(request, "race_comments.html", {"race": race, "comments": comments, "form": form})


@login_required
def races_list(request):
    races = Race.objects.all()
    race_connections = RaceConnection.objects.filter(racer=request.user.racer).values("race")
    # print(race_connections)
    racer_races = []
    for race_connection in race_connections:
        racer_races.append(race_connection['race'])
    # print(racer_races)
    return render(request, "races_list.html", {"races": races, "race_connections": racer_races})


@login_required
def delete_account(request):
    if request.method == "POST":
        request.user.delete()
        return redirect("index")
    return render(request, "delete_account.html")


@login_required
def create_race_connection(request, race_id):
    user = request.user
    if not (hasattr(user, "racer")):
        return HttpResponse("You have not got a racer")
    else:
        try:
            race_connection = RaceConnection()
            race = Race.objects.get(pk=race_id)
            race_connection.race = race
            race_connection.racer = user.racer
            race_connection.save()
        except Exception as ex:
            print(ex)
            return HttpResponse('You have already registrated')
        return redirect("races_list")
    return redirect("races_list")


def delete_race_connection(request, race_id):
    racer = request.user.racer
    race = Race.objects.get(pk=race_id)
    RaceConnection.objects.filter(racer=racer, race=race).delete()
    return redirect("races_list")
</code></pre>
<h3 id="formspy">forms.py:</h3>
<pre><code>class LoginForm(forms.Form):
    username = forms.CharField()
    password = forms.CharField(widget=forms.PasswordInput)


class RegistrationForm(forms.ModelForm):
    class Meta:
        model = User
        fields = ["username", "password", "first_name", "last_name"]


class RacerForm(forms.ModelForm):
    class Meta:
        model = Racer
        fields = ["team", "car", "description", "experience", "type"]


class UserUpdateForm(forms.ModelForm):
    class Meta:
        model = User
        fields = ["first_name", "last_name"]


class CommentForm(forms.ModelForm):
    class Meta:
        model = Comment
        fields = ["comment_type", "rating", "text"]


class RaceConnectionForm(forms.ModelForm):
    class Meta:
        model = RaceConnection
        fields = ["race"]
</code></pre>
<h3 id="urlspy">urls.py:</h3>
<pre><code>urlpatterns = [
    path('admin/', admin.site.urls),
    path("", views.index, name="index"),
    path('login/', views.user_login, name='login'),
    path('logout/', views.user_logout, name='logout'),
    path('profile/', views.profile, name='profile'),
    path("registration/", views.registration, name="registration"),
    path("racer_registration/", views.racer_registration, name="racer_registration"),
    path("edit_user/", views.edit_user, name="edit_user"),
    path("change_password/", views.change_password, name="change_password"),
    path("edit_racer/", views.edit_racer, name="edit_racer"),
    path("races/comments/&lt;int:race_id&gt;/", views.race_comments, name="race_comments"),
    path("races/", views.races_list, name="races_list"),
    path("profile/delete/", views.delete_account, name="delete_account"),
    path("create_race_connection/&lt;int:race_id&gt;/", views.create_race_connection, name="create_race_connection"),
    path("delete_race_connection/&lt;int:race_id&gt;", views.delete_race_connection, name="delete_race_connection")
]
</code></pre>
<h2 id="_2">Результат</h2>
<h3 id="_3">Главная страница:</h3>
<p><img alt="Результат" src="../images/1.png" /></p>
<h3 id="_4">Страница регистрации:</h3>
<p><img alt="Результат" src="../images/2.png" /></p>
<h3 id="_5">Страница авторизации:</h3>
<p><img alt="Результат" src="../images/3.png" /></p>
<h3 id="_6">Профиль:</h3>
<p><img alt="Результат" src="../images/4.png" /></p>
<h3 id="_7">Редактирование пользователя:</h3>
<p><img alt="Результат" src="../images/5.png" /></p>
<h3 id="_8">Смена пароля:</h3>
<p><img alt="Результат" src="../images/6.png" /></p>
<h3 id="_9">Регистрация гонщика:</h3>
<p><img alt="Результат" src="../images/7.png" /></p>
<h3 id="_10">Редактирование гонщика:</h3>
<p><img alt="Результат" src="../images/8.png" /></p>
<h3 id="_11">Создание гонки:</h3>
<p><img alt="Результат" src="../images/9.png" /></p>
<h3 id="_12">Список гонок:</h3>
<p><img alt="Результат" src="../images/10.png" /></p>
<h3 id="_13">Регистрация на гонку:</h3>
<p><img alt="Результат" src="../images/11.png" /></p>
<h3 id="_14">Отмена регистрации на гонку:</h3>
<p><img alt="Результат" src="../images/12.png" /></p>
<h3 id="_15">Добавление комментария к гонке:</h3>
<p><img alt="Результат" src="../images/13.png" /></p>
<h3 id="_16">Просмотр комментариев к гонке:</h3>
<p><img alt="Результат" src="../images/14.png" /></p>
<h3 id="_17">Выбор победителя гонки:</h3>
<p><img alt="Результат" src="../images/15.png" /></p>
<h3 id="_18">Просмотр победителя гонки:</h3>
<p><img alt="Результат" src="../images/16.png" /></p>
<h3 id="_19">Выход из профиля:</h3>
<p><img alt="Результат" src="../images/17.png" /></p>
<h3 id="_20">Удаление аккаунта:</h3>
<p><img alt="Результат" src="../images/18.png" /></p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../js/bootstrap.bundle.min.js"></script>
        <script>
            var base_url = "..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../js/base.js"></script>
        <script src="../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
